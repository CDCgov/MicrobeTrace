<!--<div id="map" [ngStyle]="svgStyle"></div>-->
<!--<p-gmap #gmap [options]="options" [overlays]="overlays"  [style]="{'width':'100%','height':'600px'}" (onMapReady)="setMap($event)"></p-gmap>-->

<!-- <ng-container *ngIf="SelectedGeospatialTypeVariable === 'On'">
<br/> -->
<!-- <h4>Range <p-calendar [(ngModel)]="dateFilterRangeDates" selectionMode="range" [readonlyInput]="true"></p-calendar></h4> -->
<!--<h4>Range: {{dateFilterRangeDates[0] | date: 'shortDate'}} - {{dateFilterRangeDates[1] | date: 'shortDate'}}</h4> -->
<!-- <h4>Range: {{dateFilterRangeValues[0] + ' - ' + dateFilterRangeValues[1]}}</h4> -->
<!--<p-slider [(ngModel)]="dateFilterRangeValues" [style]="{'width':'100%'}" [range]="true" [min]="0" [max]="dateFilterRangeMax" (onSlideEnd)="onDateFilterChange($event)"></p-slider>
</ng-container> -->


<div class="OSM-credit">Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.</div>

<div id="tool-btn-container-map" class="tool-btn-container m-portlet">
    <span style="overflow: visible; position: relative; width: 110px;">
        <a title="Settings" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left" (click)="openSettings()"><i class="flaticon-settings primary"></i></a>
    </span>
    <span style="overflow: visible; position: relative; width: 110px;">
        <a title="Export Screen" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left" (click)="openExport()"><i class="flaticon-download primary"></i></a>
    </span>
    <span style="overflow: visible; position: relative; width: 110px;">
        <a id="centerMapButton" title="Center Screen" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left" (click)="openCenter()"><i class="flaticon-eye primary"></i></a>
    </span>
    <span style="overflow: visible; position: relative; width: 110px;">
        <a title="Nodes without Location Data" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left" [ngStyle]="{ color: nodesWithoutLoc.length === 0 ? '#005DAA': 'red' }" (click)="showPopup()">{{ nodesWithoutLoc.length }}</a>
    </span>
</div>
<div #mapContainer class="map-container">
  <!-- <div #gmap style="width:100%;height:600px"></div> -->
  @if (leafletInitialOptions) {
    <div class="mapStyle" leaflet [leafletOptions]="leafletInitialOptions" (leafletMapReady)="onMapReady($event)"
      [leafletMarkerCluster]="leafletMarkers" [leafletMarkerClusterOptions]="leafletMarkerClusterOptions"
      (leafletMarkerClusterReady)="onMarkerClusterReady($event)">
    </div>
  }
</div>

<div class="row">
  <div class="col-md-4">
    @if (isExporting && commonService.session.style.widgets['node-color-variable'] != 'None') {
      <h2
        class="bottom-table">
        Node Colors
      </h2>
    }
    <table id="node-color-table-bottom-map" class="bottom-table"></table>
  </div>
  <div class="col-md-4">
    @if (isExporting && commonService.session.style.widgets['link-color-variable'] != 'None') {
      <h2
        class="bottom-table">
        Link Colors
      </h2>
    }
    <table id="link-color-table-bottom-map" class="bottom-table"></table>
  </div>
</div>

@if (IsDataAvailable == false) {
  <div class="m-content">
    <div id="file-panel" class="container-fluid" style="height:500px;">
      <div id="file-prompt" class="d-flex justify-content-center">
        <h1><b>Please add data files to load...</b></h1>
        <br />
      </div>
    </div>
  </div>
}


@if (viewActive) {
  <p-dialog id="map-settings-pane" [position]="NodeMapSettingsExportDialogSettings.mapRight" [(visible)]="NodeMapSettingsExportDialogSettings.isVisible"
    header="Geospatial Settings" [contentStyle]="{'max-height': '70vh'}" appendTo="body">
    <tabset class="tab-container tabbable-line">
      <tab heading="{{'Data' | localize}}" customClass="m-tabs__item">
        <!-- <div class="form-group row">
        <div class="col-4">Geospatial</div>
        <div class="col-8">
          <p-selectButton [options]="GeospatialTypes" [(ngModel)]="SelectedGeospatialTypeVariable"
          (ngModelChange)="onGeospatialTypeChange($event)"></p-selectButton>
        </div>
      </div> -->
      <!--ng-container *ngIf="SelectedGeospatialTypeVariable === 'Off'"-->
      <div class="row">
        <div class="col-12">
          <div class="alert alert-info alert-dismissible" role="alert">
            Please select the most precise geographic data your inputs have.
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        </div>
      </div>
      <div class="form-group row" title="If your data have a latitude variable, select that here.">
        <div class="col-4">
          <a>Latitude</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-lat" [options]="FieldList" [(ngModel)]="SelectedLatitude" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a longitude variable, select that here.">
        <div class="col-4">
          <a>Longitude</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-lon" [options]="FieldList" [(ngModel)]="SelectedLongitude" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a Census Tract variable, select that here.">
        <div class="col-4">
          <a>Census Tract</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-tract" [options]="FieldList" [(ngModel)]="SelectedCensusTract" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a zipcode variable, select that here.">
        <div class="col-4">
          <a>Zipcode</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-zipcode" [options]="FieldList" [(ngModel)]="SelectedZipCode" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a County variable, select that here.">
        <div class="col-4">
          <a>County</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-county" [options]="FieldList" [(ngModel)]="SelectedCounty" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a (US) State variable, select that here.">
        <div class="col-4">
          <a>State</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-state" [options]="FieldList" [(ngModel)]="SelectedState" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a Country variable, select that here.">
        <div class="col-4">
          <a>Country</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-country" [options]="FieldList" [(ngModel)]="SelectedCountry" class="width-percent-100"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <!--/ng-container>
      <ng-container *ngIf="SelectedGeospatialTypeVariable === 'On'">
        <p>&#11044;  -  Residence Address</p>
        <p>&#9650;  -  Venue Address</p>
        <p>&#9632;  -  Exposure Address</p-->
        <!-- <div class="form-group row" title="If your data have a Residence Address variable, select that here.">
        <div class="col-4">
          <a>Residence Address &#11044;</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-country" [options]="FieldList" [(ngModel)]="SelectedResidenceAddress"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a Venue Address variable, select that here.">
        <div class="col-4">
          <a>Venue Address &#9650;</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-country" [options]="FieldList" [(ngModel)]="SelectedVenueAddress"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
      <div class="form-group row" title="If your data have a Exposure Address variable, select that here.">
        <div class="col-4">
          <a>Exposure Address &#9632;</a>
        </div>
        <div class="col-8">
          <p-select id="map-field-country" [options]="FieldList" [(ngModel)]="SelectedExposureAddress"
          (ngModelChange)="onDataChange($event)" appendTo="body"></p-select>
        </div>
      </div>
    </ng-container-->
  </tab>
  <tab heading="{{'Components' | localize}}" customClass="m-tabs__item">
    <p-accordion [value]="null" [multiple]="true">
      <p-accordion-panel value="map-network" style="color:#495057">
        <p-accordion-header>Network</p-accordion-header>
        <p-accordion-content><div class="form-group row" title="Would you like to see Nodes on the map?">
          <div class="col-4">Nodes</div>
          <div class="col-8">
            <p-selectButton [options]="NodesTypes" [allowEmpty]="false" id="map-node-show-hide" fluid
              [(ngModel)]="SelectedNodesTypeVariable"
            (ngModelChange)="onMapNodeShowHideChange($event)"></p-selectButton>
          </div>
        </div>
        <div class="form-group row" title="Would you like to see links on the map?">
          <div class="col-4">Links</div>
          <div class="col-8">
            <p-selectButton [options]="LinksTypes" [allowEmpty]="false" id="map-link-show-hide" fluid
              [(ngModel)]="SelectedLinksTypeVariable"
            (ngModelChange)="onMapLinksShowHideChange($event)"></p-selectButton>
          </div>
        </div>
      </p-accordion-content>
    </p-accordion-panel>
    <p-accordion-panel value="map-offline" style="color:#495057">
      <p-accordion-header>Offline</p-accordion-header>
      <p-accordion-content><div class="form-group row" title="Would you like to see Countries on the map?">
        <div class="col-4">Countries</div>
        <div class="col-8">
          <p-selectButton [options]="CountriesTypes" [allowEmpty]="false" id="map-countries-show-hide" fluid
            [(ngModel)]="SelectedCountriesTypeVariable"
          (ngModelChange)="onCountriesShowHidChange($event)"></p-selectButton>
        </div>
      </div>
      <div class="form-group row" title="Would you like to see (US) States on the map?">
        <div class="col-4">States</div>
        <div class="col-8">
          <p-selectButton [options]="StatesTypes" [allowEmpty]="false" id="map-states-show-hide" fluid
            [(ngModel)]="SelectedStatesTypeVariable"
          (ngModelChange)="onStatesShowHideChange($event)"></p-selectButton>
        </div>
      </div>
      <div class="form-group row" title="Would you like to see (US) Counties on the map?">
        <div class="col-4">Counties</div>
        <div class="col-8">
          <p-selectButton [options]="CountiesTypes" [allowEmpty]="false" id="map-counties-show-hide" fluid
            [(ngModel)]="SelectedCountiesTypeVariable"
          (ngModelChange)="onCountiesShowHideChange($event)"></p-selectButton>
        </div>
      </div>
    </p-accordion-content>
  </p-accordion-panel>
  <p-accordion-panel value="map-online" style="color:#495057">
    <p-accordion-header>Online</p-accordion-header>
    <p-accordion-content><div class="row">
      <div class="col-12">
        <div class="alert alert-warning alert-dismissible" role="alert">
          Enabling any of the layers below will  <br/>download tiles from the Internet. <!--a
        href="https://github.com/CDCgov/MicrobeTrace/wiki/Tile-Maps" target="_blank">Read More.</a-->
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
  </div>
  <div id="baseRow" class="form-group row ifOnline" title="Would you like to use a Tile Basemap?">
    <div class="col-4">Basemap</div>
    <div class="col-8">
      <p-selectButton [options]="BasemapTypes" [allowEmpty]="false" id="map-basemap-show-hide" fluid
        [(ngModel)]="SelectedBasemapTypeVariable" (ngModelChange)="onBasemapChange($event)">
      </p-selectButton>
    </div>
  </div>
  <div class="form-group row ifOnline" title="Would you like to use a Satellite layer?">
    <div class="col-4">Satellite</div>
    <div class="col-8">
      <p-selectButton [options]="SatelliteTypes" [allowEmpty]="false" id="map-satellite-show-hide" fluid
        [(ngModel)]="SelectedSatelliteTypeVariable" (ngModelChange)="onSatelliteChange($event)">
      </p-selectButton>
    </div>
  </div>
</p-accordion-content>
</p-accordion-panel>
</p-accordion>
</tab>
<tab heading="{{'Nodes' | localize}}" customClass="m-tabs__item">
  <div class="form-group row">
    <div class="col-4">Color</div>
    <div class="col-8"><button class="btn btn-sm map-btn w-100"
    (click)="displayColorOptions()">Color Options</button></div>
  </div>
  <div class="form-group row">
    <div class="col-4">Collapsing</div>
    <div class="col-8">
      <p-selectButton [options]="NodeCollapsingTypes" [(ngModel)]="SelectedNodeCollapsingTypeVariable" id="map-node-collapsing" fluid
      (ngModelChange)="onNodeCollapsingChange($event)"></p-selectButton>
    </div>
  </div>
  <div class="form-group row" title="How transparent would you like the nodes to be?">
    <div class="col-4"><label for="map-node-transparency">Transparency</label></div>
    <div class="col-8"><input type="range" class="custom-range" id="map-node-transparency" min="0.00"
      max="1.00" step="0.01" value="0.00" [(ngModel)]="SelectedNodeTransparencyVariable"
    (ngModelChange)="onNodeTransparencyChange($event)"></div>
  </div>
  <div class="form-group row" title="How much randomness do you want to add to node locations?">
    <div class="col-4 padding-right-5">
      <label for="map-node-jitter">Jitter</label>
      <button id="map-node-jitter-reroll" class="btn map-btn btn-sm" (click)="onNodeJitterChange()" style="margin-left: 5px;">Reroll</button>
    </div>
    <div class="col-8"><input type="range" class="custom-range" id="map-node-jitter" min="-2" max="2"
      step="0.01" value="-2" [(ngModel)]="SelectedNodeJitterVariable"
    (ngModelChange)="onNodeJitterChange($event)"></div>
  </div>
  <div class="form-group row" title="What node data should be displayed as a tooltip for the node?">
    <div class="col-4"><label for="map-node-tooltip-variable">Tooltip</label></div>
    <div class="col-8">
      <p-select id="map-node-tooltip-variable" [options]="FieldList" appendTo="body" class="width-percent-100"
        [(ngModel)]="SelectedNodeTooltipVariable" (ngModelChange)="onNodeToolTipChange($event)">
      </p-select>
    </div>
  </div>
</tab>
<tab heading="{{'Links' | localize}}" customClass="m-tabs__item">
  <div class="form-group row">
    <div class="col-4">Color</div>
    <div class="col-8"><button class="btn btn-sm map-btn w-100" 
    (click)="displayColorOptions()">Color Options</button></div>
  </div>
  <div class="form-group row" title="How transparent would you like links to be?">
    <div class="col-4"><label for="map-link-transparency">Transparency</label></div>
    <div class="col-8"><input type="range" class="custom-range" id="map-link-transparency" min="0.00"
      max="1.00" step="0.01" value="0.00" [(ngModel)]="SelectedLinkTransparencyVariable"
    (ngModelChange)="onLinkTransparencyChange($event)"></div>
  </div>
  <div class="form-group row" title="What link data would you like displayed as a tooltip for the link?">
    <div class="col-4"><label for="map-link-tooltip-variable">Tooltip</label></div>
    <div class="col-8">
      <p-select id="map-link-tooltip-variable" [options]="LinkToolTipList" appendTo="body" class="width-percent-100"
        [(ngModel)]="SelectedLinkTooltipVariable" (ngModelChange)="onLinkToolTipChange($event)">
      </p-select>
    </div>
  </div>
</tab>
</tabset>
</p-dialog>
}


@if (viewActive) {
  <p-dialog id="network-export-modal" [(visible)]="ShowGEOMapExportPane" header="Export Geospatial Data"
    (onHide)="onCloseExport()" appendTo="body">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-body" style='min-width: 400px; height: 100%;'>
          <div class="form-group row">
            <div class="col-9">
              <input type="text" id="map-export-filename" class="form-control form-control-sm"
                placeholder="Filename" [(ngModel)]="SelectedNetworkExportFilenameVariable">
              </div>
              <div class="col-3">
                <p-select id="map-export-filetype" [options]="NetworkExportFileTypeList" appendTo="body"
                [(ngModel)]="SelectedNetworkExportFileTypeListVariable"></p-select>
              </div>
            </div>
            <div>
              <p-accordion [value]="null" [multiple]="true">
                <p-accordion-panel value="map-export-advanced" style="color:#495057">
                  <p-accordion-header>Advanced</p-accordion-header>
                  <p-accordion-content><div id="map-export-advanced">
                    <div class="form-group row">
                      <div class="col-3">
                        <label for="map-export-scale">Scale</label>
                      </div>
                      <div class="col-9">
                        <input type="number" id="map-export-scale"
                          class="form-control form-control-sm" min="0" step="0.1" value="1"
                          [(ngModel)]="SelectedNetworkExportScaleVariable"
                          (ngModelChange)="updateCalculatedResolution($event)">
                        </div>
                      </div>
                      <div class="form-group row">
                        <div class="col-3">Resolution</div>
                        <div id="map-export-dimensions" class="col-9 text-right">
                        {{CalculatedResolution}}</div>
                      </div>
                      <div class="row">
                        <div class="col-3">
                          <label for="map-export-quality">Quality</label>
                        </div>
                        <div class="col-9">
                          <input type="range" class="custom-range" id="map-export-quality" min="0"
                            max="1.0" value="0.92" step="0.01"
                            [(ngModel)]="SelectedNetworkExportQualityVariable">
                          </div>
                        </div>
                      </div>
                    </p-accordion-content>
                  </p-accordion-panel>
                </p-accordion>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-error"
              (click)="ShowGEOMapExportPane = !ShowGEOMapExportPane">Cancel</button>
              <button type="button" id="map-export" class="btn btn-primary"
              (click)="exportVisualization($event)">Export</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </p-dialog>
      }<!-- /.modal -->

      <div id="mapTooltip"></div>

      @if (viewActive) {
        <p-dialog header="Excluded Nodes" [(visible)]="showPopupMessage" [style]="{ 'width': '35rem', 'max-height': '40rem' }">
          @if (nodesWithoutLoc.length == 0) {
            <span class="text-surface-500 dark:text-surface-400 block mb-8">All nodes contain location data.</span>
          } @else {
            <span *ngIf="nodesWithoutLoc.length > 0" class="text-surface-500 dark:text-surface-400 block mb-8">The following nodes didn't contain location data and were omitted from Map View:
              <ol>
                @for (node of nodesWithoutLoc; track node) {
                  <li><span>Index: {{ node.index }}, ID: {{ node.ID }}</span></li>
                }
              </ol>
            </span>
          }
        </p-dialog>
      }