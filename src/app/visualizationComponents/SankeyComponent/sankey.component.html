<div class="m-content">
    <div id="tool-btn-container" class="m-portlet">
        <span style="overflow: visible; position: relative; width: 110px;">
            <a title="Settings" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left"
                (click)="openSettings()"><i class="flaticon-settings primary"></i></a>
        </span>
        <span style="overflow: visible; position: relative; width: 110px;">
            <a title="Export Screen" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left"
                (click)="openExport()"><i class="flaticon-download primary"></i></a>
        </span>
        <span style="overflow: visible; position: relative; width: 110px;">
            <a title="Center Screen" class="btn btn-sm btn-clean btn-icon btn-icon-md" style="float:left"
                (click)="openCenter()"><i class="flaticon-eye primary"></i></a>
        </span>
    </div>
    <div class="m-portlet__body" style="height: 100%">
        <div id="sankey-container" style="padding: 60px 10px 10px 20px" (mouseup)="endDrag()" (mouseleave)="endDrag()" (mousemove)="move($event)">
            <svg #sankeySVG [attr.width]="svgWidth" [attr.height]="svgHeight">
                <rect [attr.width]="svgWidth" [attr.height]="svgHeight" fill="#ffffff"></rect>
                <g *ngFor="let field of SankeyFieldNames; index as i">
                    <text [attr.x]="layerPositions[i]" [attr.y]="svgHeight-50">{{ commonService.capitalize(field) }}</text>
                </g>
                <g>
                    <g *ngFor="let linkA of data['links']">
                        <path [attr.d]="getLinkPathDefinition(linkA)" [attr.stroke]="getLinkColor(linkA)" [attr.stroke-width]=linkA.width [attr.opacity]="linkA.opacity" fill="none" (mouseenter)="showTooltip($event, linkA, 'Link')" (mouseleave)="hideTooltip()"></path>
                    </g>
                </g>
                <g>
                    <g *ngFor="let node of data['nodes']">
                        <rect [attr.transform]="getNodeTransform(node)" [attr.width]="node.x1-node.x0" [attr.height]="node.y1-node.y0" [attr.fill]="node.color" (mouseenter)="showTooltip($event, node, 'Node')" (mouseleave)="hideTooltip()" (mousedown)="startDrag(node)"></rect>
                        <text [attr.x]="node.x1+4" [attr.y]="(node.y0+node.y1)/2+2">{{ node.name }}</text>
                    </g>
                </g>
            </svg>
        </div>
        <div id="sankey-tooltip-container"></div>
    </div>
</div>
<div #tooltip class="custom-tooltip" [style.top.px]="tooltipY" [style.left.px]="tooltipX" [style.display]="tooltipVisible ? 'block' : 'none'">
  <table>
    <tr *ngFor="let row of tooltipData">
        <td>{{ row['key']}}: </td>
        <td>{{ row['value'] }}</td></tr>
  </table>
</div>
<div class="view-controls">
    <p-dialog *ngIf="viewActive" id="sankey-settings-pane" [(visible)]="SankeyExportDialogSettings.isVisible"
        [contentStyle]="{'overflow': 'visible'}" header="Sankey Chart Settings" appendTo="body">
        <tabset class="tab-container tabbable-line">
            <tab heading="{{'Tree' | localize}}" [active]="true" customClass="m-tabs__item" style="width: 400px; padding: 10px 10px 0px 10px;">
                <div>
                    <div class="form-group row gantt-start-row" title="What field would you like to add to the Sankey Chart?" style="overflow:visible">
                        <div class="col-4"><label>Field Name</label></div>
                        <div class="col-8">
                            <p-dropdown appendTo="body" [options]="FieldList" [(ngModel)]="SelectedFieldName"> </p-dropdown>
                        </div>
                    </div>
                    <div class="form-group row gantt-add-row" style="overflow:visible">
                        <div class="col-4"></div>
                        <div class="col-8">
                            <button type="button" class="btn btn-primary" (click)="addSelectedField()" [disabled]="fieldListFull() || this.SelectedFieldName == ''">Add Field</button>
                        </div>
                    </div>
                    <p-table [value]="SankeyFieldNames" styleClass="p-datatable-striped" *ngIf="SankeyFieldNames.length > 0" (onRowReorder)="reorderRows($event)">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 3rem;"></th>
                                <th class='p-1 table-header-row'>Name</th>
                                <th style="width: 3rem;"></th>
                                <th>Remove</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-rowData let-index="rowIndex">
                            <tr [pReorderableRow]="index">
                                <td><span class="pi pi-bars" pReorderableRowHandle></span></td>
                                <td>{{ rowData }}</td>
                                <td><input type="color" style="border:none" [(ngModel)]="layerColors[index]" (ngModelChange)="updateColors(index)"></td>
                                <td><p-button icon="pi pi-times" (onClick)="removeField(rowData)"/></td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </tab>
            <tab heading="{{'Link Color' | localize}}" customClass="m-tabs__item" style="width: 400px; padding: 10px 10px 0px 10px;">
                <div class="form-group row gantt-start-row" title="" style="overflow:visible">
                    <div class="col-3"><label>Link Color</label></div>
                    <div class="col-6">
                        <p-dropdown appendTo="body" [options]="LinkColorOptions" [(ngModel)]="SelectedColorOption"> </p-dropdown>
                    </div>
                    <div div class="col-3" *ngIf="SelectedColorOption=='Uniform'">
                        <input type="color" style="border:none" [(ngModel)]="SelectedColorForUniform">
                    </div>
                </div>
            </tab>
        </tabset>
    </p-dialog>
</div>

<p-dialog *ngIf="viewActive" [(visible)]="ShowSankeyExportPane" header="Export Sankey Chart"
    class="dialogSize" (onHide)="onCloseExport()" appendTo="body">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body" style='min-width: 500px; height: 100%;'>
                <div class="form-group row">
                    <div class="col-8">
                        <input type="text" class="form-control form-control-sm" style="height: 42px;"
                            placeholder="Image Filename" [(ngModel)]="SelectedSankeyImageFilename">
                    </div>
                    <div class="col-4">
                        <p-dropdown [options]="NetworkExportFileTypeList"
                            [(ngModel)]="SelectedNetworkExportFileTypeListVariable"></p-dropdown>
                    </div>
                </div>
                <div [hidden]="SelectedNetworkExportFileTypeListVariable=='svg'">
                    <p-accordion>
                        <p-accordionTab style="color:#495057" header="Advanced">
                            <div>
                                <div class="form-group row">
                                    <div class="col-3">
                                        <span>Scale</span>
                                    </div>
                                    <div class="col-9">
                                        <input type="number" class="form-control form-control-sm" min="0" max="2" step="0.1" [(ngModel)]="SankeyExportScaleVariable" (ngModelChange)="updateCalculatedResolution()">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-3">Resolution</div>
                                    <div class="col-9 text-right">{{CalculatedResolution}}</div>
                                </div>
                            </div>
                        </p-accordionTab>
                    </p-accordion>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-error" (click)="ShowSankeyExportPane=false">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="exportVisualization()">Export</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</p-dialog><!-- /.modal -->